import * as _ from 'lodash';
import { Subject } from 'rxjs';
import { debounceTime, filter, takeUntil } from 'rxjs/operators';
export class OfSchemaModel {
    constructor(config) {
        this.layout = 'vertical';
        this.focusFisrtInit = true;
        this.errorNotValid = 'Vui lòng điền đầy đủ thông tin!';
        this.backUpDisables = {};
        this.render$ = new Subject();
        this.isSearchBox = false;
        this.searchBtnBusy = false;
        this.searchEvent$ = new Subject();
        this.rebuilder$ = new Subject();
        this.submitted = false;
        this.fields = config.fields;
        this.id = Number(new Date());
        this.focusFisrtInit = (config === null || config === void 0 ? void 0 : config.focusFisrtInit) || true;
        this.errorNotValid = (config === null || config === void 0 ? void 0 : config.errorNotValid) || 'Vui lòng điền đầy đủ thông tin!';
        this.isSearchBox = (config === null || config === void 0 ? void 0 : config.isSearchBox) || false;
    }
    get value() {
        var _a;
        return ((_a = this.form) === null || _a === void 0 ? void 0 : _a.getRawValue()) || null;
    }
    get valueValid() {
        var _a;
        if ((_a = this.form) === null || _a === void 0 ? void 0 : _a.valid) {
            return this.value;
        }
        return null;
    }
    getField(name) {
        var _a;
        return ((_a = this.fields) === null || _a === void 0 ? void 0 : _a.find(x => x.dataField === name)) || null;
    }
    getFormControl(name) {
        return this.form.get(name);
    }
    disableField(name, f = true) {
        setTimeout(() => {
            const ctr = this.getFormControl(name);
            if (ctr) {
                if (f) {
                    ctr.disable({ onlySelf: true });
                }
                else {
                    ctr.enable({ onlySelf: true });
                }
            }
            // tslint:disable-next-line:no-shadowed-variable
            const field = this.fields.find((f) => f.dataField === name);
            if (field) {
                field.disabled = f;
            }
        });
    }
    disableAll(f = true) {
        if (f) {
            this.backUpDisables = {};
            _.forEach(this.fields, field => {
                if (field.disabled) {
                    this.backUpDisables[field.dataField] = true;
                }
                field.disabled = true;
                const ctr = this.getFormControl(field.dataField);
                if (ctr) {
                    ctr.disable({ onlySelf: true });
                }
            });
            this.triggerRender();
            return;
        }
        _.forEach(this.fields, field => {
            const ctr = this.getFormControl(field.dataField);
            if (ctr) {
                const backUp = this.backUpDisables[field.dataField];
                if (backUp) {
                    ctr.disable({ onlySelf: true });
                    field.disabled = true;
                }
                else {
                    ctr.enable({ onlySelf: true });
                    field.disabled = false;
                }
            }
        });
        this.triggerRender();
    }
    hiddenFields(fields) {
        _.forEach(fields, field => {
            this.getField(field).hidden = true;
        });
    }
    showFields(fields) {
        _.forEach(fields, field => {
            this.getField(field).hidden = false;
        });
    }
    setHidden(fields, hiddens) {
        _.forEach(fields, (field, idx) => {
            this.getField(field).hidden = hiddens[idx];
        });
    }
    setShow(fields, shows) {
        _.forEach(fields, (field, idx) => {
            this.getField(field).hidden = !shows[idx];
        });
    }
    fieldValueChanges(name, time = 100) {
        var _a;
        return (_a = this.form) === null || _a === void 0 ? void 0 : _a.get(name).valueChanges.pipe(debounceTime(time));
    }
    valueChanges(time = 100) {
        var _a;
        return (_a = this.form) === null || _a === void 0 ? void 0 : _a.valueChanges.pipe(debounceTime(time));
    }
    patchValue(value) {
        Object.keys(value).forEach(name => {
            const f = this.form.get(name);
            if (f) {
                f.patchValue(value[name]);
            }
        });
        this.triggerRender();
    }
    triggerRender() {
        setTimeout(() => {
            this.render$.next(Number(new Date()));
        }, 500);
    }
    subRender(cdr, destroy$) {
        this.render$.pipe(filter(s => s > 0)).pipe(debounceTime(111))
            .pipe(takeUntil(destroy$))
            .subscribe(d => {
            cdr.detectChanges();
        });
    }
    addControls(controls, indexBegin = null) {
        if (indexBegin === null) {
            this.fields = _.concat(this.fields, controls);
        }
        else {
            this.fields = _.flatMap(this.fields, (value, index) => {
                if (index === indexBegin) {
                    return [...controls, value];
                }
                return value;
            });
        }
        this.rebuilder();
    }
    rebuilder() {
        setTimeout(() => {
            this.rebuilder$.next(Number(new Date()));
        });
    }
    search() {
        if (this.searchEvent$) {
            this.searchEvent$.next(this.value);
        }
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoib2Ytc2NoZW1hLm1vZGVsLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vLi4vLi4vcHJvamVjdHMvb2Yvc3JjL2xpYi9tb2RlbHMvb2Ytc2NoZW1hLm1vZGVsLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUNBLE9BQU8sS0FBSyxDQUFDLE1BQU0sUUFBUSxDQUFDO0FBRzVCLE9BQU8sRUFBYyxPQUFPLEVBQUUsTUFBTSxNQUFNLENBQUM7QUFDM0MsT0FBTyxFQUFFLFlBQVksRUFBRSxNQUFNLEVBQUUsU0FBUyxFQUFFLE1BQU0sZ0JBQWdCLENBQUM7QUFhakUsTUFBTSxPQUFPLGFBQWE7SUFnQnhCLFlBQVksTUFBMkI7UUFidkMsV0FBTSxHQUErQixVQUFVLENBQUM7UUFHaEQsbUJBQWMsR0FBRyxJQUFJLENBQUM7UUFDdEIsa0JBQWEsR0FBRyxpQ0FBaUMsQ0FBQztRQUMxQyxtQkFBYyxHQUFHLEVBQUUsQ0FBQztRQUNwQixZQUFPLEdBQUcsSUFBSSxPQUFPLEVBQVUsQ0FBQztRQUN4QyxnQkFBVyxHQUFHLEtBQUssQ0FBQztRQUNwQixrQkFBYSxHQUFHLEtBQUssQ0FBQztRQUN0QixpQkFBWSxHQUFHLElBQUksT0FBTyxFQUFPLENBQUM7UUFDbEMsZUFBVSxHQUFHLElBQUksT0FBTyxFQUFVLENBQUM7UUFDbkMsY0FBUyxHQUFHLEtBQUssQ0FBQztRQUdoQixJQUFJLENBQUMsTUFBTSxHQUFHLE1BQU0sQ0FBQyxNQUFNLENBQUM7UUFDNUIsSUFBSSxDQUFDLEVBQUUsR0FBRyxNQUFNLENBQUMsSUFBSSxJQUFJLEVBQUUsQ0FBQyxDQUFDO1FBQzdCLElBQUksQ0FBQyxjQUFjLEdBQUcsQ0FBQSxNQUFNLGFBQU4sTUFBTSx1QkFBTixNQUFNLENBQUUsY0FBYyxLQUFJLElBQUksQ0FBQztRQUNyRCxJQUFJLENBQUMsYUFBYSxHQUFHLENBQUEsTUFBTSxhQUFOLE1BQU0sdUJBQU4sTUFBTSxDQUFFLGFBQWEsS0FBSSxpQ0FBaUMs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QyxDQUFDO1NBQ3BDO0lBQ0gsQ0FBQztDQUNGIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgQWJzdHJhY3RDb250cm9sLCBGb3JtR3JvdXAgfSBmcm9tICdAYW5ndWxhci9mb3Jtcyc7XHJcbmltcG9ydCAqIGFzIF8gZnJvbSAnbG9kYXNoJztcclxuaW1wb3J0IHsgQ2hhbmdlRGV0ZWN0b3JSZWYgfSBmcm9tICdAYW5ndWxhci9jb3JlJztcclxuaW1wb3J0IHsgT2ZDb250cm9sTW9kZWwgfSBmcm9tICcuL29mLWNvbnRyb2wubW9kZWwnO1xyXG5pbXBvcnQgeyBPYnNlcnZhYmxlLCBTdWJqZWN0IH0gZnJvbSAncnhqcyc7XHJcbmltcG9ydCB7IGRlYm91bmNlVGltZSwgZmlsdGVyLCB0YWtlVW50aWwgfSBmcm9tICdyeGpzL29wZXJhdG9ycyc7XHJcblxyXG5cclxuZXhwb3J0IGludGVyZmFjZSBPZlNjaGVtYU1vZGVsQ29uZmlnIHtcclxuICBsYXlvdXQ/OiAnaG9yaXpvbnRhbCcgfCAndmVydGljYWwnO1xyXG4gIGZpZWxkczogT2ZDb250cm9sTW9kZWxbXTtcclxuICAvLy8gZm9jdXMgdsOgbyBjb250cm9sIMSR4bqndSB0acOqbiBraGkgaW5pdCB2aWV3XHJcbiAgZm9jdXNGaXNydEluaXQ/OiBib29sZWFuO1xyXG4gIGVycm9yTm90VmFsaWQ/OiBzdHJpbmc7XHJcbiAgaXNTZWFyY2hCb3g/OiBib29sZWFuO1xyXG59XHJcblxyXG5cclxuZXhwb3J0IGNsYXNzIE9mU2NoZW1hTW9kZWwge1xyXG5cclxuICBpZDogbnVtYmVyO1xyXG4gIGxheW91dD86ICdob3Jpem9udGFsJyB8ICd2ZXJ0aWNhbCcgPSAndmVydGljYWwnO1xyXG4gIGZpZWxkczogT2ZDb250cm9sTW9kZWxbXTtcclxuICBmb3JtOiBGb3JtR3JvdXA7XHJcbiAgZm9jdXNGaXNydEluaXQgPSB0cnVlO1xyXG4gIGVycm9yTm90VmFsaWQgPSAnVnVpIGzDsm5nIMSRaeG7gW4gxJHhuqd5IMSR4bunIHRow7RuZyB0aW4hJztcclxuICBwcml2YXRlIGJhY2tVcERpc2FibGVzID0ge307XHJcbiAgcHJpdmF0ZSByZW5kZXIkID0gbmV3IFN1YmplY3Q8bnVtYmVyPigpO1xyXG4gIGlzU2VhcmNoQm94ID0gZmFsc2U7XHJcbiAgc2VhcmNoQnRuQnVzeSA9IGZhbHNlO1xyXG4gIHNlYXJjaEV2ZW50JCA9IG5ldyBTdWJqZWN0PGFueT4oKTtcclxuICByZWJ1aWxkZXIkID0gbmV3IFN1YmplY3Q8bnVtYmVyPigpO1xyXG4gIHN1Ym1pdHRlZCA9IGZhbHNlO1xyXG5cclxuICBjb25zdHJ1Y3Rvcihjb25maWc6IE9mU2NoZW1hTW9kZWxDb25maWcpIHtcclxuICAgIHRoaXMuZmllbGRzID0gY29uZmlnLmZpZWxkcztcclxuICAgIHRoaXMuaWQgPSBOdW1iZXIobmV3IERhdGUoKSk7XHJcbiAgICB0aGlzLmZvY3VzRmlzcnRJbml0ID0gY29uZmlnPy5mb2N1c0Zpc3J0SW5pdCB8fCB0cnVlO1xyXG4gICAgdGhpcy5lcnJvck5vdFZhbGlkID0gY29uZmlnPy5lcnJvck5vdFZhbGlkIHx8ICdWdWkgbMOybmcgxJFp4buBbiDEkeG6p3kgxJHhu6cgdGjDtG5nIHRpbiEnO1xyXG4gICAgdGhpcy5pc1NlYXJjaEJveCA9IGNvbmZpZz8uaXNTZWFyY2hCb3ggfHwgZmFsc2U7XHJcblxyXG4gIH1cclxuXHJcbiAgZ2V0IHZhbHVlKCkge1xyXG4gICAgcmV0dXJuIHRoaXMuZm9ybT8uZ2V0UmF3VmFsdWUoKSB8fCBudWxsO1xyXG4gIH1cclxuXHJcbiAgZ2V0IHZhbHVlVmFsaWQoKSB7XHJcbiAgICBpZiAodGhpcy5mb3JtPy52YWxpZCkge1xyXG4gICAgICByZXR1cm4gdGhpcy52YWx1ZTtcclxuICAgIH1cclxuICAgIHJldHVybiBudWxsO1xyXG4gIH1cclxuXHJcbiAgZ2V0RmllbGQobmFtZTogc3RyaW5nKSB7XHJcbiAgICByZXR1cm4gdGhpcy5maWVsZHM/LmZpbmQoeCA9PiB4LmRhdGFGaWVsZCA9PT0gbmFtZSkgfHwgbnVsbDtcclxuICB9XHJcblxyXG4gIGdldEZvcm1Db250cm9sKG5hbWU6IHN0cmluZyk6IEFic3RyYWN0Q29udHJvbCB8IG51bGwge1xyXG4gICAgcmV0dXJuIHRoaXMuZm9ybS5nZXQobmFtZSk7XHJcbiAgfVxyXG5cclxuICBkaXNhYmxlRmllbGQobmFtZTogc3RyaW5nLCBmID0gdHJ1ZSkge1xyXG4gICAgc2V0VGltZW91dCgoKSA9PiB7XHJcbiAgICAgIGNvbnN0IGN0ciA9IHRoaXMuZ2V0Rm9ybUNvbnRyb2wobmFtZSk7XHJcbiAgICAgIGlmIChjdHIpIHtcclxuICAgICAgICBpZiAoZikge1xyXG4gICAgICAgICAgY3RyLmRpc2FibGUoeyBvbmx5U2VsZjogdHJ1ZSB9KTtcclxuICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgY3RyLmVuYWJsZSh7IG9ubHlTZWxmOiB0cnVlIH0pO1xyXG4gICAgICAgIH1cclxuICAgICAgfVxyXG4gICAgICAvLyB0c2xpbnQ6ZGlzYWJsZS1uZXh0LWxpbmU6bm8tc2hhZG93ZWQtdmFyaWFibGVcclxuICAgICAgY29uc3QgZmllbGQgPSB0aGlzLmZpZWxkcy5maW5kKChmKSA9PiBmLmRhdGFGaWVsZCA9PT0gbmFtZSk7XHJcbiAgICAgIGlmIChmaWVsZCkge1xyXG4gICAgICAgIGZpZWxkLmRpc2FibGVkID0gZjtcclxuICAgICAgfVxyXG4gICAgfSk7XHJcblxyXG4gIH1cclxuXHJcbiAgZGlzYWJsZUFsbChmID0gdHJ1ZSkge1xyXG4gICAgaWYgKGYpIHtcclxuICAgICAgdGhpcy5iYWNrVXBEaXNhYmxlcyA9IHt9O1xyXG4gICAgICBfLmZvckVhY2godGhpcy5maWVsZHMsIGZpZWxkID0+IHtcclxuICAgICAgICBpZiAoZmllbGQuZGlzYWJsZWQpIHtcclxuICAgICAgICAgIHRoaXMuYmFja1VwRGlzYWJsZXNbZmllbGQuZGF0YUZpZWxkXSA9IHRydWU7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIGZpZWxkLmRpc2FibGVkID0gdHJ1ZTtcclxuICAgICAgICBjb25zdCBjdHIgPSB0aGlzLmdldEZvcm1Db250cm9sKGZpZWxkLmRhdGFGaWVsZCk7XHJcbiAgICAgICAgaWYgKGN0cikge1xyXG4gICAgICAgICAgY3RyLmRpc2FibGUoeyBvbmx5U2VsZjogdHJ1ZSB9KTtcclxuICAgICAgICB9XHJcbiAgICAgIH0pO1xyXG4gICAgICB0aGlzLnRyaWdnZXJSZW5kZXIoKTtcclxuICAgICAgcmV0dXJuO1xyXG4gICAgfVxyXG4gICAgXy5mb3JFYWNoKHRoaXMuZmllbGRzLCBmaWVsZCA9PiB7XHJcbiAgICAgIGNvbnN0IGN0ciA9IHRoaXMuZ2V0Rm9ybUNvbnRyb2woZmllbGQuZGF0YUZpZWxkKTtcclxuICAgICAgaWYgKGN0cikge1xyXG4gICAgICAgIGNvbnN0IGJhY2tVcCA9IHRoaXMuYmFja1VwRGlzYWJsZXNbZmllbGQuZGF0YUZpZWxkXTtcclxuICAgICAgICBpZiAoYmFja1VwKSB7XHJcbiAgICAgICAgICBjdHIuZGlzYWJsZSh7IG9ubHlTZWxmOiB0cnVlIH0pO1xyXG4gICAgICAgICAgZmllbGQuZGlzYWJsZWQgPSB0cnVlO1xyXG4gICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICBjdHIuZW5hYmxlKHsgb25seVNlbGY6IHRydWUgfSk7XHJcbiAgICAgICAgICBmaWVsZC5kaXNhYmxlZCA9IGZhbHNlO1xyXG4gICAgICAgIH1cclxuICAgICAgfVxyXG4gICAgfSk7XHJcbiAgICB0aGlzLnRyaWdnZXJSZW5kZXIoKTtcclxuXHJcbiAgfVxyXG5cclxuICBoaWRkZW5GaWVsZHMoZmllbGRzOiBzdHJpbmdbXSkge1xyXG4gICAgXy5mb3JFYWNoKGZpZWxkcywgZmllbGQgPT4ge1xyXG4gICAgICB0aGlzLmdldEZpZWxkKGZpZWxkKS5oaWRkZW4gPSB0cnVlO1xyXG4gICAgfSk7XHJcblxyXG4gIH1cclxuXHJcbiAgc2hvd0ZpZWxkcyhmaWVsZHM6IHN0cmluZ1tdKSB7XHJcbiAgICBfLmZvckVhY2goZmllbGRzLCBmaWVsZCA9PiB7XHJcbiAgICAgIHRoaXMuZ2V0RmllbGQoZmllbGQpLmhpZGRlbiA9IGZhbHNlO1xyXG4gICAgfSk7XHJcblxyXG4gIH1cclxuXHJcbiAgc2V0SGlkZGVuKGZpZWxkczogc3RyaW5nW10sIGhpZGRlbnM6IGJvb2xlYW5bXSkge1xyXG4gICAgXy5mb3JFYWNoKGZpZWxkcywgKGZpZWxkLCBpZHgpID0+IHtcclxuICAgICAgdGhpcy5nZXRGaWVsZChmaWVsZCkuaGlkZGVuID0gaGlkZGVuc1tpZHhdO1xyXG4gICAgfSk7XHJcbiAgfVxyXG5cclxuICBzZXRTaG93KGZpZWxkczogc3RyaW5nW10sIHNob3dzOiBib29sZWFuW10pIHtcclxuICAgIF8uZm9yRWFjaChmaWVsZHMsIChmaWVsZCwgaWR4KSA9PiB7XHJcbiAgICAgIHRoaXMuZ2V0RmllbGQoZmllbGQpLmhpZGRlbiA9ICFzaG93c1tpZHhdO1xyXG4gICAgfSk7XHJcbiAgfVxyXG5cclxuICBmaWVsZFZhbHVlQ2hhbmdlcyhuYW1lOiBzdHJpbmcsIHRpbWUgPSAxMDApIHtcclxuICAgIHJldHVybiB0aGlzLmZvcm0/LmdldChuYW1lKS52YWx1ZUNoYW5nZXMucGlwZShkZWJvdW5jZVRpbWUodGltZSkpO1xyXG4gIH1cclxuXHJcbiAgdmFsdWVDaGFuZ2VzKHRpbWUgPSAxMDApIHtcclxuICAgIHJldHVybiB0aGlzLmZvcm0/LnZhbHVlQ2hhbmdlcy5waXBlKGRlYm91bmNlVGltZSh0aW1lKSk7XHJcbiAgfVxyXG5cclxuICBwYXRjaFZhbHVlKHZhbHVlOiBhbnkpIHtcclxuICAgIE9iamVjdC5rZXlzKHZhbHVlKS5mb3JFYWNoKG5hbWUgPT4ge1xyXG4gICAgICBjb25zdCBmID0gdGhpcy5mb3JtLmdldChuYW1lKTtcclxuICAgICAgaWYgKGYpIHtcclxuICAgICAgICBmLnBhdGNoVmFsdWUodmFsdWVbbmFtZV0pO1xyXG4gICAgICB9XHJcbiAgICB9KTtcclxuICAgIHRoaXMudHJpZ2dlclJlbmRlcigpO1xyXG4gIH1cclxuXHJcbiAgdHJpZ2dlclJlbmRlcigpIHtcclxuICAgIHNldFRpbWVvdXQoKCkgPT4ge1xyXG4gICAgICB0aGlzLnJlbmRlciQubmV4dChOdW1iZXIobmV3IERhdGUoKSkpO1xyXG4gICAgfSwgNTAwKTtcclxuICB9XHJcblxyXG4gIHN1YlJlbmRlcihjZHI6IENoYW5nZURldGVjdG9yUmVmLCBkZXN0cm95JDogT2JzZXJ2YWJsZTxhbnk+KSB7XHJcbiAgICB0aGlzLnJlbmRlciQucGlwZShmaWx0ZXIocyA9PiBzID4gMCkpLnBpcGUoZGVib3VuY2VUaW1lKDExMSkpXHJcbiAgICAgIC5waXBlKHRha2VVbnRpbChkZXN0cm95JCkpXHJcbiAgICAgIC5zdWJzY3JpYmUoZCA9PiB7XHJcbiAgICAgICAgY2RyLmRldGVjdENoYW5nZXMoKTtcclxuICAgICAgfSk7XHJcbiAgfVxyXG5cclxuICBhZGRDb250cm9scyhjb250cm9sczogT2ZDb250cm9sTW9kZWxbXSwgaW5kZXhCZWdpbjogbnVtYmVyID0gbnVsbCkge1xyXG4gICAgaWYgKGluZGV4QmVnaW4gPT09IG51bGwpIHtcclxuICAgICAgdGhpcy5maWVsZHMgPSBfLmNvbmNhdCh0aGlzLmZpZWxkcywgY29udHJvbHMpO1xyXG4gICAgfSBlbHNlIHtcclxuICAgICAgdGhpcy5maWVsZHMgPSBfLmZsYXRNYXAodGhpcy5maWVsZHMsICh2YWx1ZSwgaW5kZXgpID0+IHtcclxuICAgICAgICBpZiAoaW5kZXggPT09IGluZGV4QmVnaW4pIHtcclxuICAgICAgICAgIHJldHVybiBbLi4uY29udHJvbHMsIHZhbHVlXTtcclxuICAgICAgICB9XHJcbiAgICAgICAgcmV0dXJuIHZhbHVlO1xyXG4gICAgICB9KTtcclxuICAgIH1cclxuICAgIHRoaXMucmVidWlsZGVyKCk7XHJcbiAgfVxyXG5cclxuICByZWJ1aWxkZXIoKSB7XHJcbiAgICBzZXRUaW1lb3V0KCgpID0+IHtcclxuICAgICAgdGhpcy5yZWJ1aWxkZXIkLm5leHQoTnVtYmVyKG5ldyBEYXRlKCkpKTtcclxuICAgIH0pO1xyXG4gIH1cclxuXHJcbiAgc2VhcmNoKCkge1xyXG4gICAgaWYgKHRoaXMuc2VhcmNoRXZlbnQkKSB7XHJcbiAgICAgIHRoaXMuc2VhcmNoRXZlbnQkLm5leHQodGhpcy52YWx1ZSk7XHJcbiAgICB9XHJcbiAgfVxyXG59XHJcbiJdfQ==